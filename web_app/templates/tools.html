{% extends "base.html" %}

{% block title %}Tools{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Advanced Tools</h1>
    
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">Manage Shift Definitions (Master)</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">Add, update, or delete shift definitions directly in <code>03_shifts_master.json</code>.</p>
            <form id="shiftMasterForm">
                <div class="form-row">
                    <div class="form-group col-md-3">
                        <label for="shiftId">Shift ID</label>
                        <input type="text" class="form-control" id="shiftId" placeholder="e.g. A10-GS" required>
                    </div>
                    <div class="form-group col-md-3">
                        <label for="startTime">Start Time</label>
                        <input type="time" class="form-control" id="startTime">
                    </div>
                    <div class="form-group col-md-3">
                        <label for="endTime">End Time</label>
                        <input type="time" class="form-control" id="endTime">
                    </div>
                    <div class="form-group col-md-3">
                        <label for="duration">Duration (min)</label>
                        <input type="number" class="form-control" id="duration" placeholder="e.g. 480">
                    </div>
                </div>
                <button type="button" class="btn btn-success mr-2" id="addShiftBtn">Add / Update</button>
                <button type="button" class="btn btn-danger" id="deleteShiftBtn">Delete</button>
            </form>
            
            <div class="mt-3">
                <h6>Console Output:</h6>
                <pre id="shiftMasterOutput" style="background-color: #f0f0f0; padding: 10px; max-height: 150px; overflow-y: auto; border: 1px solid #ccc;">Waiting for action...</pre>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Extract Needs from CSV</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">Run the python tool to extract shift counts from a raw planning CSV.</p>
            <form id="extractNeedsForm">
                <div class="form-group">
                    <label for="csvPath">CSV File Path (Optional)</label>
                    <input type="text" class="form-control" id="csvPath" placeholder="Default: tool/planning_brut.csv">
                    <small class="form-text text-muted">Leave empty to use the default file path defined on the server.</small>
                </div>
                <button type="button" class="btn btn-primary" id="runExtractBtn">Run Extraction</button>
            </form>
            
            <div class="mt-3">
                <h6>Console Output:</h6>
                <pre id="extractOutput" style="background-color: #f0f0f0; padding: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #ccc;">Ready to run.</pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- TOOL 1: Manage Shifts ---
    const shiftOutput = document.getElementById('shiftMasterOutput');
    
    function runShiftAction(action) {
        const shiftId = document.getElementById('shiftId').value.trim();
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        const duration = document.getElementById('duration').value;

        if (!shiftId) {
            alert("Shift ID is required.");
            return;
        }

        let url = `/api/tool/manage_shift_master?action=${action}&shift_id=${encodeURIComponent(shiftId)}`;
        
        if (action === 'add_update') {
            if (!startTime || !endTime || !duration) {
                alert("Start Time, End Time, and Duration are required for Add/Update.");
                return;
            }
            url += `&start_time=${startTime}&end_time=${endTime}&duration=${duration}`;
        }

        shiftOutput.textContent = `Processing ${action} for ${shiftId}...\n`;
        const eventSource = new EventSource(url);

        eventSource.onmessage = function(event) {
            shiftOutput.textContent += event.data + '\n';
            shiftOutput.scrollTop = shiftOutput.scrollHeight;
            eventSource.close(); 
        };

        eventSource.onerror = function(err) {
            console.error("EventSource failed:", err);
            eventSource.close();
        };
    }

    document.getElementById('addShiftBtn').addEventListener('click', () => runShiftAction('add_update'));
    document.getElementById('deleteShiftBtn').addEventListener('click', () => {
        if(confirm("Are you sure you want to delete this shift?")) {
            runShiftAction('delete');
        }
    });

    // --- TOOL 2: Extract Needs ---
    const extractOutput = document.getElementById('extractOutput');
    const runExtractBtn = document.getElementById('runExtractBtn');

    document.getElementById('runExtractBtn').addEventListener('click', () => {
        const csvPath = document.getElementById('csvPath').value.trim();
        let url = '/api/tool/extract_needs';
        if (csvPath) {
            url += `?csv_path=${encodeURIComponent(csvPath)}`;
        }

        extractOutput.textContent = 'Starting extraction process...\n';
        runExtractBtn.disabled = true;

        const eventSource = new EventSource(url);

        eventSource.onmessage = function(event) {
            extractOutput.textContent += event.data + '\n';
            extractOutput.scrollTop = extractOutput.scrollHeight;
            
            if (event.data.includes("finished successfully") || event.data.includes("ERROR:")) {
                eventSource.close();
                runExtractBtn.disabled = false;
            }
        };

        eventSource.onerror = function(err) {
            console.error("EventSource failed:", err);
            eventSource.close();
            runExtractBtn.disabled = false;
        };
    });
});
</script>
{% endblock %}