{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Solver Settings</h2>

    <form id="settings-form">
        <!-- General Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h4>General</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="solver_time_limit_seconds" class="form-label">Solver Time Limit (seconds)</label>
                        <input type="number" class="form-control" id="solver_time_limit_seconds" name="solver_time_limit_seconds">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="max_refinement_iterations" class="form-label">Max Refinement Iterations</label>
                        <input type="number" class="form-control" id="max_refinement_iterations" name="max_refinement_iterations">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="min_improvement_threshold" class="form-label">Min Improvement Threshold</label>
                        <input type="number" step="0.001" class="form-control" id="min_improvement_threshold" name="min_improvement_threshold">
                    </div>
                </div>
            </div>
        </div>

        <!-- Employee Rules -->
        <div class="card mb-4">
            <div class="card-header">
                <h4>Employee Rules</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="min_off_days_per_month" class="form-label">Min OFF Days per Month (Default)</label>
                        <input type="number" class="form-control" id="min_off_days_per_month" name="min_off_days_per_month">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="max_consecutive_work_days" class="form-label">Max Consecutive Work Days</label>
                        <input type="number" class="form-control" id="max_consecutive_work_days" name="max_consecutive_work_days">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="min_rest_hours" class="form-label">Min Rest Hours Between Shifts</label>
                        <input type="number" class="form-control" id="min_rest_hours" name="min_rest_hours">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="guaranteed_weekend_off" class="form-label">Guaranteed Weekends Off</label>
                        <input type="number" class="form-control" id="guaranteed_weekend_off" name="guaranteed_weekend_off">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Group Overrides -->
        <div class="card mb-4">
            <div class="card-header">
                <h4>Group Overrides</h4>
            </div>
            <div class="card-body" id="group-min-off-days-container">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>


        <!-- Penalties -->
        <div class="card mb-4">
            <div class="card-header">
                <h4>Penalties</h4>
            </div>
            <div class="card-body" id="penalties-container">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Save Settings</button>
        <div id="success-alert" class="alert alert-success mt-3" style="display: none;" role="alert">
            Settings saved successfully!
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('settings-form');
    const penaltiesContainer = document.getElementById('penalties-container');
    const groupMinOffDaysContainer = document.getElementById('group-min-off-days-container');

    // Fetch and populate the form
    fetch('/api/settings')
        .then(response => response.json())
        .then(data => {
            // Populate simple fields
            for (const key in data) {
                if (typeof data[key] !== 'object') {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = data[key];
                    }
                }
            }
            
            // Populate group_min_off_days
            if (data.group_min_off_days) {
                let groupHtml = '<div class="row">';
                for (const groupName in data.group_min_off_days) {
                    groupHtml += `
                        <div class="col-md-6 mb-3">
                            <label for="group_min_off_days_${groupName}" class="form-label">Min OFF Days for ${groupName}</label>
                            <input type="number" class="form-control" id="group_min_off_days_${groupName}" name="group_min_off_days.${groupName}" value="${data.group_min_off_days[groupName]}">
                        </div>
                    `;
                }
                groupHtml += '</div>';
                groupMinOffDaysContainer.innerHTML = groupHtml;
            }

            // Populate penalties
            if (data.penalties) {
                let penaltyHtml = '<div class="row">';
                for (const penaltyName in data.penalties) {
                    penaltyHtml += `
                        <div class="col-md-6 mb-3">
                            <label for="penalty_${penaltyName}" class="form-label">${penaltyName.replace(/_/g, ' ')}</label>
                            <input type="number" class="form-control" id="penalty_${penaltyName}" name="penalties.${penaltyName}" value="${data.penalties[penaltyName]}">
                        </div>
                    `;
                }
                penaltyHtml += '</div>';
                penaltiesContainer.innerHTML = penaltyHtml;
            }
        });

    // Handle form submission
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(form);
        const data = {};

        // Reconstruct the nested structure
        data.penalties = {};
        data.group_min_off_days = {};

        for (const [key, value] of formData.entries()) {
            if (key.startsWith('penalties.')) {
                data.penalties[key.substring(10)] = Number(value);
            } else if (key.startsWith('group_min_off_days.')) {
                data.group_min_off_days[key.substring(21)] = Number(value);
            } else {
                data[key] = isNaN(Number(value)) ? value : Number(value);
            }
        }

        fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(result => {
            console.log('Success:', result);
            const successAlert = document.getElementById('success-alert');
            successAlert.style.display = 'block';
            setTimeout(() => {
                successAlert.style.display = 'none';
            }, 3000);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
});
</script>
{% endblock %}
