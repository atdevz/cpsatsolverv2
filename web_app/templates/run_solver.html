{% extends "base.html" %}

{% block title %}Run Solver{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Run Solver</h1>
    <button id="runSolverBtn" class="btn btn-primary mb-3">Run Solver</button>
    <div class="card">
        <div class="card-header">Solver Output</div>
        <div class="card-body">
            <pre id="solverOutput" style="white-space: pre-wrap; max-height: 400px; overflow-y: auto; background-color: #f0f0f0; padding: 10px; border: 1px solid #ccc;">Click 'Run Solver' to start the process...</pre>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const runSolverBtn = document.getElementById('runSolverBtn');
    const solverOutput = document.getElementById('solverOutput');

    runSolverBtn.addEventListener('click', () => {
        solverOutput.textContent = 'Running solver... Please wait.\n';
        runSolverBtn.disabled = true;

        const eventSource = new EventSource('/api/run_solver');

        eventSource.onmessage = function(event) {
            // 1. Append the new data to the output window
            solverOutput.textContent += event.data + '\n';
            solverOutput.scrollTop = solverOutput.scrollHeight; // Auto-scroll to bottom

            // 2. Check for specific "End of Process" messages from the server
            // This allows us to close the connection manually before the server cuts it,
            // preventing the browser from interpreting it as a network error.
            if (event.data.includes("Le script du solveur a terminé avec succès") || 
                event.data.includes("ERROR:")) {
                console.log("Process finished. Closing stream.");
                eventSource.close();
                runSolverBtn.disabled = false;
            }
        };

        eventSource.onerror = function(err) {
            // This will now only fire on real network errors or unexpected crashes
            console.error("EventSource failed:", err);
            solverOutput.textContent += '\nError: Connection lost or server error.\n';
            runSolverBtn.disabled = false;
            eventSource.close();
        };

        eventSource.onopen = function() {
            console.log("EventSource connected.");
        };
    });
});
</script>
{% endblock %}